#!/bin/bash

# Maintainer: manuel (see forum.endeavouros.com)

pkgname=eos-iso-hotfix
pkgdesc="EndeavourOS ISO hotfixes"

url="https://github.com/endeavouros-team/ISO-hotfixes/"

pkgver=26.02
pkgrel=2

arch=('any')
license=('GPL')
depends=(git)

# URLs to hotfix files and files managed by hotfixes.
_url_hotfix="https://raw.githubusercontent.com/endeavouros-team/ISO-hotfixes/refs/heads/main"
_url_script="https://raw.githubusercontent.com/endeavouros-team/calamares/refs/heads/calamares/data/eos/scripts"
_url_module="https://raw.githubusercontent.com/endeavouros-team/calamares/refs/heads/calamares/data/eos/modules"

_prepare_eos_iso_hotfix() {
    # This function fetches the latest hotfix files and some related calamares files.
    # Fetch hotfix files from github using 'git clone'.
    # The files that hotfixes will use should also be listed below.
    #
    # If hotfixes change (e.g. need new files), this function may fail.
    # Then modify the lists of files according to changes required by the hotfixes.

    local script_files=(                          # hotfixes may use/modify these files
        $_url_script/cleaner_script.sh
        $_url_script/chrooted_cleaner_script.sh
    )
    local module_files=(                          # hotfixes may use/modify these files
        $_url_module/packagechooser.conf
        $_url_module/pacstrap.conf
    )
    local hotfix_files=(                          # this will contain the hotfix files, see below
        # $_url_hotfix/hotfix-end.bash
        # $_url_hotfix/hotfix-start.bash
        # $_url_hotfix/netinstall.yaml-cassini-R3.patch
        # $_url_hotfix/netinstall.yaml_mercury_neo.patch
        # $_url_hotfix/packagechooser.conf_ganymede.patch
        # $_url_hotfix/packagechooser.conf_mercury_neo.patch
        # $_url_hotfix/packagechooser.conf_endeavour_neo_1.patch
        # $_url_hotfix/packagechooser.conf_gemini_1.patch
        # $_url_hotfix/packagechooser.conf.patch
        # $_url_hotfix/pacstrap.conf_endeavour_neo.patch
        # $_url_hotfix/README.md
        # $_url_hotfix/settings_offline.conf.patch
        # $_url_hotfix/settings_online.conf.patch
        # $_url_hotfix/packagechooser.conf_ganymede_neo.patch
        # $_url_hotfix/netinstall.yaml_ganymede_neo.patch

    )

    # Download hotfix files since these might change often.
    local dir=$(mktemp -d)
    chmod go-rwx $dir
    hotfix_files=()

    # Find the names of all the latest hotfix files.
    git clone https://github.com/endeavouros-team/ISO-hotfixes.git "$dir" &>/dev/null || {
        rm -rf $dir
        exit 1
    }
    local file
    for file in $(/bin/ls -1 "$dir") ; do
        case "$file" in
            *.bash | *.patch | *.md)
                hotfix_files+=("$_url_hotfix/${file##*/}") ;;
        esac
    done
    rm -rf "$dir"

    source=(
        $( printf "%s\n" "${hotfix_files[@]}" "${script_files[@]}" "${module_files[@]}" | sort -V)
    )
    # Now 'source' should contain all the latest files (URLs) needed to support the hotfix feature in the EndeavourOS installer.
}
_prepare_eos_iso_hotfix

sha512sums=('a4899c8405fee4b00e8d7fe2cd41c89280a798496929bc74519b6247f158e6259dd11e7817c24495c549a5cf232985fe676d8fca87c931e2bee8571e5ce9cc4c'
            '0efec1ab124a22bc95c822852ecc0ba6d6a7231fb0958da92f6dbdb19d036611634d16aba0615f8fe0e0ba634d47bc8c79bb3bc9786c36ef7534f2e1bc04ade1'
            '83425b3c1f2a8ed23d2061bc5ad805fe4e311ce64849a061f3c301f52afdd0f1c280ec242c4af4b8e2db16d6b55e550de4baff64f8e53f18281b26afcfbf8620'
            '5dab144e787cc9649cd57addbbc542ece54ada5085dda42c9baf10201fcb406c74056969f93622d3a0d6be5ba70d053a16e299e699b21d0f64402eabf93abd6e'
            'b352da65f1613bf5a4db2339757db713f1d8f6f33da0a3e566ca2b127b91d2a2a0160f607f9c8d026aaf010212c4e9b2a28b0fe7cc6392c0dd5ec0bb5cb841c2'
            '75c30687f979a8e1a03ba94688728464408c06a239120ab8b5ccfdbaa94803e30fbf9b0280243450380ec285ac795b35e22e27918b8a51509389398df1c0da84'
            'e5d8bbe5d22e3535ce2c67c42c92328dd25f2a64559b5d6e6acc05917bf8a076a49a8781f94b53e9d1a27a410a36ff2c86efbfbbbdbd345b1d5b7fb5e0087319'
            '8e4c446dab9b31c2deeb44218629d7c82354b5433925768cb2b4c2c6279bd36f80ddcd4063d9ed5da0d55105b061e1b7a1a51da3fc9fe9433e2e387243f7739d'
            'b68be30ee80cb6b2fca41ac85cb9560addeb0c061afef75bd956dc50cbed397ed20878bd677a16033df591d3b9ae2b2f6bf44bd82da2aa4e9d6367873e809688'
            '76632ce6465bb97d3df00c0dc59116fd82c366731e6c2e4f9c38c7a4f7e800c4e734e824779d367c427d98ed8cf20059084889f822868e96e2cd6aed650625e1'
            '3aa95fce738c40e4b239c35339195165261717938f0f3e2653c01610cf6da6bfa2548287d821a8bee0906e0a3a623129e1f1304c34946602de9fe46ad3e304c6'
            '47cf864cd1ec5c28e64d322126515aabfdcfeb37fce71d97d29056d09eb71af8402c47813fb921d6cde26da498d5de0e450b1926cb6b8e88e512941b2927a094'
            'eddfe733abd98f53e7481d147e78dec4bea5b7438ceeb967460fae63ae9390f6173d55a26fca715d0e99c15b2ddf595b780cc81ca63d2b0b1b9ec531d7b94a92'
            '8d0176fec8dff63dd57a282bc69385d0db93d2b2656c52f95483040f1d7d071b6f7d4032273480d3729a55cf3f1db5bd45e4e616891dc2d0b150a214ecfb9890'
            '9c48e4b7d752ace0ff6c806b649b9a30cd2a89ca7d5ddad54065fa140dc8069a126bc7997b8ca40bb09645454108687ec0595a048e77a80903b97f770cebab22'
            '18dd32904f4d3bfb603998682f2d4f334e268b95fdf451c549b05269edbf691954ad2814ca4e7afaff006d0059a889abf27982f903be48b8c06d1809ea29e18a'
            '3be11b43d06d9499eba1bd9c44fb00cc2e2ec8ccdf8b881ae0ae045baad4e18b2bab276b3e82fca60642ebf38da91c18b8bb3d1a2b53c46989a038a182f89e9c'
            'b672ea045503dcb33bee237cd2bbc6ecc6d736d9aac2f734cf15d65eec8570c69c814f69568ee0b1799ed4bc532a2e37cc657aea062a4cdc3800c8b2d3bfa5cb'
            'f0846f936c995db6fe4f8412b215d36fcd82d79b4838507b31de9c64c456d0f3487eb5e0f84c32c8b114b8e617e27d91a6ccb36780457b70ddd627a50a823437')

package() {
    local item src
    local cleanups=()

    for src in "${source[@]}" ; do
        item="${src##*/}"
        case "$src" in
            ${_url_script}/*)   install -Dm755 "$item" "$pkgdir/usr/share/endeavouros/hotfix/scripts/$item" ;;
            ${_url_module}/*)   install -Dm644 "$item" "$pkgdir/usr/share/endeavouros/hotfix/modules/$item" ;;
            ${_url_hotfix}/*)   install -Dm644 "$item" "$pkgdir/usr/share/endeavouros/hotfix/hotfixes/$item" ;;
        esac
        cleanups+=("../$item")
    done
    rm -f "${cleanups[@]}"
}
