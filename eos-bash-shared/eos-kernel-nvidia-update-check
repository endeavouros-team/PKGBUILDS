#!/bin/bash

# On Nvidia GPU machines, kernel and nvidia driver must update together:
# - if linux-lts is updated, nvidia-lts should be updated too
# - if linux     is updated, nvidia     should be updated too
#
# This app checks the above and informs the user with messages
# and the calling app with exit code (0=success, 1=failure).

Main()
{
    local targets="$*"
    local target
    local linux_lts=no
    local linux=no
    local nvidia_lts=no
    local nvidia=no
    local nvidia_pkgs
    local msgs=() msg
    local progname=$(/usr/bin/basename "$0")

    if [ -z "$targets" ] ; then
        targets=$(/usr/bin/checkupdates  | /usr/bin/awk '{print $1}')
    fi

    # stop if no nvidia package is already installed
    nvidia_pkgs="$(/usr/bin/pacman -Qq nvidia-dkms nvidia nvidia-lts 2>/dev/null)"
    [ -z "$nvidia_pkgs" ] && return

    # stop if nvidia-dkms is already installed
    [ -n "$(echo "$nvidia_pkgs" | /usr/bin/grep nvidia-dkms)" ] && return

    # stop if kernel will not be updated
    for target in $targets ; do
        case "$target" in
            linux)      linux=yes ;;
            linux-lts)  linux_lts=yes ;;
        esac
    done
    [ "$linux $linux_lts" = "no no" ] && return

    # notify if kernel will be updated but corresponding nvidia driver not
    for target in $targets ; do
        case "$target" in
            nvidia)     nvidia=yes ;;
            nvidia-lts) nvidia_lts=yes ;;
        esac
    done
    [ "$linux_lts $nvidia_lts" = "yes no" ] && msgs+=("'linux-lts' would be upgraded but 'nvidia-lts' not.")
    [ "$linux $nvidia" = "yes no" ]         && msgs+=("'linux' would be upgraded but 'nvidia' not.")

    if [ -n "$msgs" ] ; then
        for msg in "${msgs[@]}" ; do
            echo "$progname: error: $msg" >&2
        done
        exit 1
    fi
}

Main "$@"
