#!/bin/bash

DIE() {
    echo "$progname: error: $1" >&2
    exit 1
}

Options() {
    local arg
    for arg in "$@" ; do
        case "$arg" in
            -c | --clear)
                read -p "Are you sure you want to clear the contents of $logfile? " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]
                    then
                    truncate -s 0 $logfile
                fi
                exit 0
                ;;
            -g | --go)
                xdg-open $EOS_SENDLOG_URI > /dev/null 2>&1
                exit 0
                ;;  
            -h | --help)
                cat <<EOF
Directs standard input into a service at address
    $EOS_SENDLOG_URI
and saves returned URLs into file
    $db
To change default service address edit file 
    $configfile

Usage: $progname [options]
options:
    -c | --clear    Clear the contents of $logfile.
    -g | --go       Go to service homepage at $EOS_SENDLOG_URI.
    -h | --help     Display this help.
    -n | --nosave   Don't save returned URL in $logfile.
    -s | --show     Show the contents of $logfile.
EOF
                exit 0
                ;;
            -n | --nosave)
                save=no
                ;;
            -s | --show)
               cat $logfile
               exit 0
               ;;  
            -*) DIE "invalid option '$arg' use -h/--help to show valid options" ;;
            *) DIE "invalid parameter '$arg'" ;;
        esac
    done
}

SendToNet() {
    url=$(curl --no-progress-meter -F "$EOS_SENDLOG_FORM" "$EOS_SENDLOG_URI")
}

Init() {
    local service

    [ -r $configfile ] && source $configfile

    for ((service=0; service < ${#supported_uris[@]}; service++)) ; do
        if [ "$EOS_SENDLOG_URI" = "${supported_uris[$service]}" ] ; then
            EOS_SENDLOG_FORM="${supported_forms[$service]}"
            return
        fi
    done
    # use default:
    EOS_SENDLOG_URI="${supported_uris[$default_service]}"
    EOS_SENDLOG_FORM="${supported_forms[$default_service]}"
}

Main() {
    local progname="$(basename "$0")"
    local configfile=/etc/$progname.conf
    local logfile=$HOME/.config/$progname.txt

    # from config file (if values are set, they must be correct!):
    local EOS_SENDLOG_URI=""
    local EOS_SENDLOG_FORM=""

    local supported_uris=(
        "https://0x0.st/"
        "http://ix.io"
    )
    local supported_forms=(
        "file=@-"
        "f:1=<-"
    )
    local default_service=0

    Init
    local save=yes
    local db=$logfile
    local url

    Options "$@"

    SendToNet

    if [ "$save" = "yes" ] ; then
        local tmpfile=$(mktemp $logfile.XXXXX)
        [ -r $db ] && mv $db $tmpfile
        printf "%s: %s\n" "$(date +'%Y-%m-%d-%T')" "$url" > $db
        cat $tmpfile >> $db
        rm -f $tmpfile
    fi
    echo "$url"
}

Main "$@"
